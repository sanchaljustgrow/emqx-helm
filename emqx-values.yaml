
replicaCount: 3

service:
  type: NodePort
  ports:
    mqtt: 1883
    mqtts: 8883
    dashboard: 18083
    ws: 8083
    wss: 8084

persistence:
  enabled: true
  size: 5Gi
  storageClass: standard
  mountPath: /opt/emqx/data

dashboard:
  defaultUsername: admin
  defaultPassword: StrongPass123

cluster:
  k8sAutoDiscovery: true
  mnesia:
    enabled: true
    dir: /opt/emqx/data/mnesia
    replicas: 3     # match/current goal replicas

extraConfig:
  emqx:
    mqtt:
      allow_anonymous: true
      persistent_client_expiration: 24h
      session_qos_1_retry: 60
      max_clientid_len: 64

# Resource requests are essential for HPA's utilization targets
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2000m
    memory: 4Gi

# If the chart supports autoscaling, this block should render an HPA.
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 10
  targetCPUUtilizationPercentage: 50
  targetMemoryUtilizationPercentage: 50

# Spread pods across distinct nodes (optional but recommended on 4-node cluster)
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - emqx
        topologyKey: kubernetes.io/hostname

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: emqx

